<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Test - CareerOS Interview Function</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #output {
      background: #1a1a1a;
      color: #00ff00;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      height: 400px;
      overflow-y: auto;
      margin: 20px 0;
    }
    .controls {
      margin: 20px 0;
    }
    button {
      background: #007cba;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #005a8b;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-weight: bold;
    }
    .status.connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.disconnected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.connecting {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    input[type="text"] {
      width: 300px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé§ CareerOS WebSocket Test Harness</h1>
    <p>This page tests the connection to the Supabase Edge Function that proxies OpenAI's Realtime API.</p>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <div class="controls">
      <button id="connectBtn" onclick="connect()">Connect to Edge Function</button>
      <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
      <button id="clearBtn" onclick="clearOutput()">Clear Log</button>
    </div>
    
    <div class="controls">
      <input type="text" id="messageInput" placeholder="Enter custom message (JSON)" value='{"type": "session.update", "session": {"voice": "alloy"}}'>
      <button id="sendBtn" onclick="sendCustomMessage()" disabled>Send Message</button>
    </div>
    
    <div class="controls">
      <button onclick="sendPing()" disabled id="pingBtn">Send Ping</button>
      <button onclick="sendSessionUpdate()" disabled id="sessionBtn">Send Session Update</button>
      <button onclick="sendTestAudio()" disabled id="audioBtn">Send Test Audio</button>
    </div>
    
    <div id="output"></div>
  </div>

  <script>
    let ws = null;
    const output = document.getElementById("output");
    const status = document.getElementById("status");
    const connectBtn = document.getElementById("connectBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");
    const sendBtn = document.getElementById("sendBtn");
    const pingBtn = document.getElementById("pingBtn");
    const sessionBtn = document.getElementById("sessionBtn");
    const audioBtn = document.getElementById("audioBtn");

    // Using the CORRECT Supabase WebSocket URL format
    const WEBSOCKET_URL = "wss://deofbwuazrvpocyybjpl.functions.supabase.co/realtime-interview";

    function log(msg, type = 'info') {
      const timestamp = new Date().toISOString();
      const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üìù';
      const logMsg = `[${timestamp}] ${prefix} ${msg}`;
      console.log(logMsg);
      output.innerHTML += `<div>${logMsg}</div>`;
      output.scrollTop = output.scrollHeight;
    }

    function updateStatus(state, message) {
      status.className = `status ${state}`;
      status.textContent = message;
    }

    function updateButtons(connected) {
      connectBtn.disabled = connected;
      disconnectBtn.disabled = !connected;
      sendBtn.disabled = !connected;
      pingBtn.disabled = !connected;
      sessionBtn.disabled = !connected;
      audioBtn.disabled = !connected;
    }

    function connect() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        log("Already connected!", 'warning');
        return;
      }

      log(`Attempting to connect to: ${WEBSOCKET_URL}`);
      updateStatus('connecting', 'Connecting...');
      
      try {
        ws = new WebSocket(WEBSOCKET_URL);

        ws.onopen = () => {
          log("‚úÖ WebSocket connection established successfully!", 'success');
          updateStatus('connected', 'Connected to Edge Function');
          updateButtons(true);
          
          // Send initial ping to test basic communication
          setTimeout(() => {
            sendPing();
          }, 1000);
        };

        ws.onmessage = (event) => {
          try {
            log(`üì® Raw message received: ${event.data}`);
            
            // Try to parse as JSON for better formatting
            try {
              const parsed = JSON.parse(event.data);
              log(`üì® Parsed message: ${JSON.stringify(parsed, null, 2)}`);
              
              // Handle specific message types
              if (parsed.type === 'session.created') {
                log("üéâ OpenAI session created successfully!", 'success');
              } else if (parsed.type === 'session.updated') {
                log("üîß Session configuration updated", 'success');
              } else if (parsed.type === 'error') {
                log(`‚ùå Error from server: ${parsed.error}`, 'error');
              }
            } catch (parseError) {
              // Not JSON, just log as text
              if (event.data === 'pong') {
                log("üèì Received pong response", 'success');
              }
            }
          } catch (error) {
            log(`Error processing message: ${error.message}`, 'error');
          }
        };

        ws.onerror = (error) => {
          log(`‚ùå WebSocket error occurred: ${JSON.stringify(error)}`, 'error');
          log("This might indicate a connection issue or server error", 'error');
        };

        ws.onclose = (event) => {
          log(`üîí WebSocket connection closed: Code ${event.code}, Reason: "${event.reason}"`, 'warning');
          updateStatus('disconnected', `Disconnected (${event.code})`);
          updateButtons(false);
          
          // Log common close codes
          switch(event.code) {
            case 1000:
              log("Normal closure", 'info');
              break;
            case 1001:
              log("Going away (page reload/navigation)", 'info');
              break;
            case 1006:
              log("Abnormal closure (connection lost)", 'warning');
              break;
            default:
              log(`Unexpected close code: ${event.code}`, 'warning');
          }
        };

      } catch (error) {
        log(`Failed to create WebSocket: ${error.message}`, 'error');
        updateStatus('disconnected', 'Connection failed');
        updateButtons(false);
      }
    }

    function disconnect() {
      if (ws) {
        log("Disconnecting WebSocket...");
        ws.close(1000, "User initiated disconnect");
        ws = null;
      }
    }

    function sendPing() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        log("üì§ Sending ping...");
        ws.send('ping');
      } else {
        log("Cannot send ping - not connected", 'error');
      }
    }

    function sendSessionUpdate() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const sessionUpdate = {
          type: 'session.update',
          session: {
            modalities: ['text', 'audio'],
            instructions: 'You are conducting a professional career interview test. Respond briefly.',
            voice: 'alloy',
            input_audio_format: 'pcm16',
            output_audio_format: 'pcm16',
            input_audio_transcription: {
              model: 'whisper-1'
            },
            turn_detection: {
              type: 'server_vad',
              threshold: 0.5,
              prefix_padding_ms: 300,
              silence_duration_ms: 1000
            },
            temperature: 0.8,
            max_response_output_tokens: 'inf'
          }
        };
        
        log("üì§ Sending session update...");
        log(`Session config: ${JSON.stringify(sessionUpdate, null, 2)}`);
        ws.send(JSON.stringify(sessionUpdate));
      } else {
        log("Cannot send session update - not connected", 'error');
      }
    }

    function sendTestAudio() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        // Send a small test audio buffer (silence)
        const testAudio = {
          type: 'input_audio_buffer.append',
          audio: 'AAAA' // Base64 encoded silence
        };
        
        log("üì§ Sending test audio buffer...");
        ws.send(JSON.stringify(testAudio));
      } else {
        log("Cannot send audio - not connected", 'error');
      }
    }

    function sendCustomMessage() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const input = document.getElementById('messageInput');
        try {
          const message = JSON.parse(input.value);
          log(`üì§ Sending custom message: ${JSON.stringify(message, null, 2)}`);
          ws.send(JSON.stringify(message));
        } catch (error) {
          log(`Invalid JSON in custom message: ${error.message}`, 'error');
        }
      } else {
        log("Cannot send custom message - not connected", 'error');
      }
    }

    function clearOutput() {
      output.innerHTML = '';
      log("Log cleared");
    }

    // Auto-connect on page load for convenience
    window.onload = () => {
      log("üöÄ CareerOS WebSocket Test Harness Ready");
      log(`Target URL: ${WEBSOCKET_URL}`);
      log("Click 'Connect to Edge Function' to start testing");
    };

    // Clean disconnect on page unload
    window.onbeforeunload = () => {
      if (ws) {
        ws.close();
      }
    };
  </script>
</body>
</html>
